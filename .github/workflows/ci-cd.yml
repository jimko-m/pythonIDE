name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # Run daily builds at 2 AM UTC
    - cron: '0 2 * * *'
  release:
    types: [ published ]

env:
  GRADLE_OPTS: '-Dorg.gradle.daemon=false -Dorg.gradle.parallel=false'
  ANDROID_COMPILE_SDK: "33"
  ANDROID_BUILD_TOOLS: "33.0.0"
  ANDROID_TARGET_SDK: "33"
  ANDROID_ABIS: "arm64-v8a,armeabi-v7a"

jobs:
  # Code Quality and Testing
  test:
    name: ğŸ§ª Test and Quality Checks
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better analysis
          
      - name: ğŸ”§ Set up JDK 11
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'zulu'
          cache: gradle
          
      - name: ğŸ“± Setup Android SDK
        uses: android-actions/setup-android@v3
        with:
          api-level: 33
          build-tools: 33.0.0
          ndk: '25.2.9519653'  # Required for native code
          cmake: '3.22.1'     # For native builds
          
      - name: ğŸ’¾ Cache Gradle packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
            ~/.android/build-cache
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties', '**/ktlint/**/*.kt') }}
          restore-keys: |
            ${{ runner.os }}-gradle-
            ${{ runner.os }}-
            
      - name: ğŸ” Ktlint Code Style Check
        run: |
          ./gradlew ktlintCheck
          # Check if no style violations
          
      - name: ğŸ” Detekt Static Analysis
        run: |
          ./gradlew detekt
          # Check for code quality issues
          
      - name: ğŸ—ï¸ Grant execute permission for gradlew
        run: |
          chmod +x gradlew
          
      - name: ğŸ§ª Run Unit Tests
        run: |
          ./gradlew test \
            --info \
            --stacktrace \
            --continue \
            -Dtest.single=UnitTest
        continue-on-error: true
        
      - name: ğŸ§ª Run Integration Tests
        run: |
          ./gradlew test \
            --info \
            --stacktrace \
            --continue \
            -Dtest.single=IntegrationTest
        continue-on-error: true
        
      - name: ğŸ“Š Generate Code Coverage Report
        run: |
          ./gradlew jacocoTestReport
          # Generate coverage report
          
      - name: ğŸ“‹ Upload Coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./app/build/reports/jacoco/jacocoTestReport/jacocoTestReport.xml
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false
          
      - name: ğŸ“Š Upload Coverage Reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: code-coverage-report
          path: app/build/reports/jacoco/
          
      - name: ğŸ“Š Upload Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: app/build/test-results/

  # Security and Vulnerability Scanning
  security:
    name: ğŸ”’ Security Scan
    runs-on: ubuntu-latest
    needs: test
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ”’ Run Trivy Vulnerability Scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
          
      - name: ğŸ“¤ Upload Trivy Scan Results
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: 'trivy-results.sarif'
          
      - name: ğŸ” Run OWASP Dependency Check
        uses: dependency-check/Dependency-Check_Action@main
        with:
          project: 'python-ide-android'
          path: '.'
          format: 'ALL'
          
      - name: ğŸ“Š Upload OWASP Report
        uses: actions/upload-artifact@v4
        with:
          name: security-report
          path: reports/

  # Lint and Code Quality
  lint:
    name: ğŸ“ Lint and Code Quality
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ”§ Set up JDK 11
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'zulu'
          
      - name: ğŸ“± Setup Android SDK
        uses: android-actions/setup-android@v3
        
      - name: ğŸ” Run Android Lint
        run: |
          ./gradlew lint
          
      - name: ğŸ“Š Upload Lint Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: lint-report
          path: app/build/reports/lint/

  # Build Jobs
  build-debug:
    name: ğŸ—ï¸ Debug Build
    runs-on: ubuntu-latest
    needs: [test, lint, security]
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ”§ Set up JDK 11
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'zulu'
          
      - name: ğŸ“± Setup Android SDK
        uses: android-actions/setup-android@v3
        with:
          api-level: 33
          build-tools: 33.0.0
          
      - name: ğŸ’¾ Cache Gradle packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-
            
      - name: ğŸ”‘ Create debug keystore
        run: |
          keytool -genkey -v \
            -keystore debug.keystore \
            -storepass android \
            -alias androiddebugkey \
            -keypass android \
            -keyalg RSA \
            -keysize 2048 \
            -validity 10000 \
            -dname "CN=Android Debug,O=Android,C=US"
            
      - name: ğŸ—ï¸ Build debug APK
        run: |
          ./gradlew assembleDebug
          
      - name: ğŸ“Š Upload debug APK
        uses: actions/upload-artifact@v4
        with:
          name: debug-apk
          path: app/build/outputs/apk/debug/*.apk
          
  build-release:
    name: ğŸ—ï¸ Release Build
    runs-on: ubuntu-latest
    needs: [test, lint, security]
    if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v')
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ”§ Set up JDK 11
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'zulu'
          
      - name: ğŸ“± Setup Android SDK
        uses: android-actions/setup-android@v3
        with:
          api-level: 33
          build-tools: 33.0.0
          
      - name: ğŸ’¾ Cache Gradle packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-
            
      - name: ğŸ”‘ Create release keystore
        env:
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
        run: |
          echo "${{ secrets.KEYSTORE_FILE }}" | base64 --decode > release.keystore
          
      - name: ğŸ—ï¸ Build release APK
        run: |
          ./gradlew assembleRelease
          
      - name: ğŸ—ï¸ Build release App Bundle
        run: |
          ./gradlew bundleRelease
          
      - name: ğŸ“Š Upload release artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-artifacts
          path: |
            app/build/outputs/apk/release/*.apk
            app/build/outputs/bundle/release/*.aab
            
  # Instrumentation Testing
  instrumentation-test:
    name: ğŸ§ª Instrumentation Tests
    runs-on: ubuntu-latest
    needs: build-debug
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ”§ Set up JDK 11
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'zulu'
          
      - name: ğŸ“± Setup Android SDK
        uses: android-actions/setup-android@v3
        with:
          api-level: 33
          build-tools: 33.0.0
          
      - name: ğŸ“± Setup AVD for instrumentation testing
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 30
          arch: x86_64
          script: ./gradlew connectedAndroidTest
          
      - name: ğŸ“Š Upload instrumentation test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: instrumentation-test-results
          path: app/build/reports/androidTests/connected/

  # Performance Testing
  performance-test:
    name: âš¡ Performance Tests
    runs-on: ubuntu-latest
    needs: build-debug
    if: github.event_name == 'schedule'
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ”§ Set up JDK 11
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'zulu'
          
      - name: ğŸ“± Setup Android SDK
        uses: android-actions/setup-android@v3
        
      - name: ğŸ“± Setup AVD for performance testing
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 30
          arch: x86_64
          script: ./gradlew connectedAndroidTest -Pandroid.testInstrumentationRunnerArguments.class=com.pythonide.performance.PerformanceTest
          
      - name: ğŸ“Š Upload performance results
        uses: actions/upload-artifact@v4
        with:
          name: performance-results
          path: app/build/reports/performance/

  # Deployment Jobs
  deploy-staging:
    name: ğŸš€ Deploy to Staging
    runs-on: ubuntu-latest
    needs: [build-release, instrumentation-test]
    if: github.ref == 'refs/heads/develop'
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ“± Setup Android SDK
        uses: android-actions/setup-android@v3
        
      - name: ğŸ“¥ Download release artifacts
        uses: actions/download-artifact@v4
        with:
          name: release-artifacts
          path: ./
          
      - name: ğŸš€ Deploy to internal testing
        uses: r0adkll/upload-google-play@v1
        with:
          serviceAccountJsonPlainText: ${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT }}
          packageName: com.pythonide.enhanced
          releaseFiles: app/build/outputs/bundle/enhancedRelease/app-enhanced-release.aab
          track: internal
          rollout: 1.0
          
      - name: ğŸ“¢ Notify deployment success
        run: |
          echo "âœ… Successfully deployed to staging environment"
          echo "ğŸ“± Package: com.pythonide.enhanced"
          echo "ğŸ”— Track: internal testing"

  deploy-production:
    name: ğŸš€ Deploy to Production
    runs-on: ubuntu-latest
    needs: [build-release, instrumentation-test, performance-test]
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ“± Setup Android SDK
        uses: android-actions/setup-android@v3
        
      - name: ğŸ“¥ Download release artifacts
        uses: actions/download-artifact@v4
        with:
          name: release-artifacts
          path: ./
          
      - name: ğŸš€ Deploy to production with gradual rollout
        uses: r0adkll/upload-google-play@v1
        with:
          serviceAccountJsonPlainText: ${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT }}
          packageName: com.pythonide.enhanced
          releaseFiles: app/build/outputs/bundle/enhancedRelease/app-enhanced-release.aab
          track: production
          rollout: 0.1  # Start with 10% rollout
          
      - name: ğŸ“¢ Notify production deployment
        run: |
          echo "ğŸš€ Successfully deployed to production!"
          echo "ğŸ“± Package: com.pythonide.enhanced"
          echo "ğŸ”— Track: production"
          echo "ğŸ“Š Rollout: 10% (will increase based on metrics)"
          
      - name: ğŸ“Š Create GitHub Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref }}
          release_name: Release ${{ github.ref }}
          draft: false
          prerelease: false
          body: |
            ## ğŸ‰ Release ${{ github.ref }}
            
            ### What's New
            - Enhanced AI-powered code assistance
            - Improved cloud synchronization
            - Better performance and stability
            - New collaboration features
            
            ### Installation
            Download the APK from the assets below or update via Google Play Store.
            
            ### Notes
            This release is available to 10% of users initially and will be rolled out gradually.
            
      - name: ğŸ“¦ Upload APK to release
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: app/build/outputs/apk/release/app-enhanced-release.apk
          asset_name: pythonide-enhanced-${{ github.ref }}.apk
          asset_content_type: application/vnd.android.package-archive

  # GitHub Release for testing builds
  github-release:
    name: ğŸ“¦ GitHub Release
    runs-on: ubuntu-latest
    needs: build-debug
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸ“¥ Download debug APK
        uses: actions/download-artifact@v4
        with:
          name: debug-apk
          path: ./
          
      - name: ğŸ“¦ Create GitHub Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref }}
          release_name: Beta Release ${{ github.ref }}
          draft: false
          prerelease: true
          body: |
            ## ğŸ§ª Beta Release ${{ github.ref }}
            
            This is a beta release for testing purposes.
            
            ### What's Included
            - Latest features and improvements
            - Bug fixes from recent development
            - Performance optimizations
            
            ### Installation
            Download the APK from the assets below and sideload on your Android device.
            
            ### Feedback
            Please report any issues on GitHub Issues.
            
      - name: ğŸ“¦ Upload APK to release
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: app-debug.apk
          asset_name: pythonide-android-${{ github.ref }}-debug.apk
          asset_content_type: application/vnd.android.package-archive

  # Notify Slack/Discord on success/failure
  notify:
    name: ğŸ“¢ Notifications
    runs-on: ubuntu-latest
    needs: [deploy-staging, deploy-production, github-release]
    if: always()
    
    steps:
      - name: ğŸ“¢ Notify on success
        if: needs.deploy-production.result == 'success'
        uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
          SLACK_MESSAGE: |
            ğŸ‰ Production deployment successful!
            ğŸ“± Python IDE for Android v${{ github.ref }}
            âœ… All tests passed
            ğŸš€ Now available on Google Play Store
            
      - name: ğŸ“¢ Notify on failure
        if: needs.deploy-production.result == 'failure'
        uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
          SLACK_MESSAGE: |
            âŒ Deployment failed!
            ğŸ“± Python IDE for Android v${{ github.ref }}
            ğŸ” Please check the logs for details

# Workflow optimization settings
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true